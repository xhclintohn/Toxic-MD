// wallpaperz.js
const { zokou } = require('../framework/zokou');
const fetch = require('node-fetch');

zokou(
  {
    nomCom: 'wallpaper',
    categorie: 'Search',
    reaction: 'ğŸ–¼ï¸',
  },
  async (dest, zk, commandeOptions) => {
    const { ms, repondre, arg } = commandeOptions;

    try {
      console.log('DEBUG - wallpaper triggered:', { arg });

      if (!arg[0]) {
        return repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ DON'T WASTE MY TIME! Give me a query, like .wallpaper Sky! ğŸ˜¡\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      const query = arg.join(' ').trim();
      const apiUrl = `https://api.giftedtech.web.id/api/search/wallpaper?apikey=gifted&query=${encodeURIComponent(query)}`;

      await repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ Fetching your ${query} wallpaper, hold tight! ğŸ”\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);

      const response = await fetch(apiUrl);
      if (!response.ok) {
        throw new Error(`API error: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      if (!data.success || !data.results || data.results.length === 0) {
        return repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ NO WALLPAPERS FOUND! Try a better query, loser! ğŸ˜£\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      // Pick a random result and the highest quality image (_w635)
      const randomResult = data.results[Math.floor(Math.random() * data.results.length)];
      const imageUrl = randomResult.image.find(url => url.includes('_w635')) || randomResult.image[0];

      await zk.sendMessage(
        dest,
        {
          image: { url: imageUrl },
          caption: `ğ“ğğ—ï¿½{I}ğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ BOOM! Here's your ${query} wallpaper! ğŸ”¥\nâ”‚â’ Type: ${randomResult.type}\nâ”‚â’ Powered by xh_clinton\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`
        },
        { quoted: ms }
      );

    } catch (error) {
      console.error('wallpaper error:', error);
      await repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ EPIC FAIL! Something broke: ${error.message} ğŸ˜¡ Fix it or cry!\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
    }
  }
);