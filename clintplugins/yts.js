const util = require('util');
const { zokou } = require(__dirname + '/../framework/zokou');
const axios = require('axios');

zokou(
  {
    nomCom: 'yts',
    categorie: 'Search',
    reaction: 'ğŸ¬',
  },
  async (dest, zk, commandeOptions) => {
    const { ms, repondre, arg, nomAuteurMessage } = commandeOptions;

    try {
      console.log('DEBUG - yts triggered:', { arg, nomAuteurMessage });

      if (!arg[0]) {
        return repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ YO ${nomAuteurMessage}, STOP WASTING MY TIME! Give me a search query, like .yts Spectre! ğŸ˜¡\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      const query = arg.join(' ').trim();
      await repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ Hang on, ${nomAuteurMessage}! Scouting YouTube for "${query}" like a boss! ğŸ”\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);

      const apiUrl = `https://api.giftedtech.web.id/api/search/yts?apikey=gifted&query=${encodeURIComponent(query)}`;
      const response = await axios.get(apiUrl);
      const data = response.data;

      if (!data.success || !data.results || data.results.length === 0) {
        return repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ NO VIDEOS, ${nomAuteurMessage}! Your "${query}" search SUCKS! Try something else! ğŸ˜£\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      // Pick a random video from results
      const video = data.results[Math.floor(Math.random() * data.results.length)];

      await zk.sendMessage(
        dest,
        {
          text: `ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ NAILED IT, ${nomAuteurMessage}! Found a banger for "${query}"! ğŸ”¥\nâ”‚â’ Title: ${video.title}\nâ”‚â’ URL: ${video.url}\nâ”‚â’ Duration: ${video.duration.timestamp}\nâ”‚â’ Views: ${video.views.toLocaleString()}\nâ”‚â’ Author: ${video.author.name}\nâ”‚â’ Powered by xh_clinton\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`,
          footer: `Hey ${nomAuteurMessage}! I'm Toxic-MD, created by ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§ ğŸ˜`,
        },
        { quoted: ms }
      );

    } catch (e) {
      console.error('YouTube search error:', e);
      await repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ EPIC FAIL, ${nomAuteurMessage}! Something crashed: ${e.message} ğŸ˜¡ Fix it or cry! ğŸ˜£\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
    }
  }
);