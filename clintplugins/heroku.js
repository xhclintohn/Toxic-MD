const { zokou } = require('../framework/zokou');
const s = require('../set');

zokou(
  {
    nomCom: "setvar",
    categorie: "Heroku",
    reaction: "âš™ï¸",
  },
  async (dest, zk, commandeOptions) => {
    const { ms, repondre, superUser, arg } = commandeOptions;

    try {
      console.log('DEBUG - setvar triggered:', { arg, superUser });

      if (!superUser) {
        return repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ BACK OFF! Only mods can touch this command, peasant! ğŸ˜¡\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      if (!arg[0] || !arg.join(' ').includes('=')) {
        return repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ USELESS INPUT! Format it right, like: .setvar OWNER_NAME=xhclinton ğŸ˜¤\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      const text = arg.join(' ').trim();
      const [key, value] = text.split('=').map(str => str.trim());

      if (!key || !value) {
        return repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ STOP WASTING MY TIME! Provide a valid KEY=VALUE pair! ğŸ˜£\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      if (!s.HEROKU_API_KEY || !s.HEROKU_APP_NAME) {
        return repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ CONFIG ERROR! HEROKU_API_KEY or HEROKU_APP_NAME missing in set.js! Fix it now! ğŸ˜µ\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      const Heroku = require("heroku-client");
      const heroku = new Heroku({ token: s.HEROKU_API_KEY });
      const baseURI = `/apps/${s.HEROKU_APP_NAME}`;

      await heroku.patch(`${baseURI}/config-vars`, {
        body: { [key]: value },
      });

      await repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ BOOM! Heroku var ${key} set to ${value}! Rebooting like a boss... ğŸ’ª\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);

    } catch (error) {
      console.error('setvar error:', error);
      await repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ EPIC FAIL! Something broke: ${error.message} ğŸ˜¡ Fix it or suffer!\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
    }
  }
);

zokou(
  {
    nomCom: "allvar",
    categorie: "Heroku",
    reaction: "ğŸ“‹",
  },
  async (dest, zk, commandeOptions) => {
    const { ms, repondre, superUser } = commandeOptions;

    try {
      console.log('DEBUG - allvar triggered:', { superUser });

      if (!superUser) {
        return repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ GET LOST! Only mods can peek at the vars, loser! ğŸ˜ \nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      if (!s.HEROKU_API_KEY || !s.HEROKU_APP_NAME) {
        return repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ CONFIG DISASTER! HEROKU_API_KEY or HEROKU_APP_NAME missing in set.js! Sort it out! ğŸ˜£\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      const Heroku = require("heroku-client");
      const heroku = new Heroku({ token: s.HEROKU_API_KEY });
      const baseURI = `/apps/${s.HEROKU_APP_NAME}`;

      const vars = await heroku.get(`${baseURI}/config-vars`);
      let str = `TOXIC-MD VARS\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\n`;
      for (const vr in vars) {
        str += `â˜£ï¸ *${vr}* = ${vars[vr]}\n`;
      }
      str += `â—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`;

      await repondre(str);

    } catch (error) {
      console.error('allvar error:', error);
      await repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ CRASH AND BURN! Error: ${error.message} ğŸ˜¡ Get it together!\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
    }
  }
);

zokou(
  {
    nomCom: "getvar",
    categorie: "Heroku",
    reaction: "ğŸ”",
  },
  async (dest, zk, commandeOptions) => {
    const { ms, repondre, superUser, arg } = commandeOptions;

    try {
      console.log('DEBUG - getvar triggered:', { arg, superUser });

      if (!superUser) {
        return repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ NO ENTRY! Only mods can snoop on vars, punk! ğŸ˜¤\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      if (!arg[0]) {
        return repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ DON'T BE LAZY! Give me a variable name in CAPS! ğŸ˜¡\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      const varName = arg.join(' ').trim().toUpperCase();

      if (!s.HEROKU_API_KEY || !s.HEROKU_APP_NAME) {
        return repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ CONFIG FAILURE! HEROKU_API_KEY or HEROKU_APP_NAME missing in set.js! Fix it! ğŸ˜µ\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      const Heroku = require("heroku-client");
      const heroku = new Heroku({ token: s.HEROKU_API_KEY });
      const baseURI = `/apps/${s.HEROKU_APP_NAME}`;

      const vars = await heroku.get(`${baseURI}/config-vars`);
      if (vars[varName]) {
        await repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ GOT IT! ${varName} = ${vars[varName]} ğŸ’¥\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      } else {
        await repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ NOPE! Variable ${varName} doesn't exist, try again! ğŸ˜£\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

    } catch (error) {
      console.error('getvar error:', error);
      await repondre(`TOXIC-MD\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ TOTAL FAILURE! Error: ${error.message} ğŸ˜¡ Fix this mess!\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
    }
  }
);