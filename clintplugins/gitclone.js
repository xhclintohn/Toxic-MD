const util = require('util');
const { zokou } = require(__dirname + '/../framework/zokou');
const axios = require('axios');

zokou(
  {
    nomCom: 'github',
    categorie: 'Search',
    reaction: 'ğŸ“‚',
  },
  async (dest, zk, commandeOptions) => {
    const { ms, repondre, arg, nomAuteurMessage } = commandeOptions;

    try {
      console.log('DEBUG - github triggered:', { arg, nomAuteurMessage });

      if (!arg[0]) {
        return repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ YO ${nomAuteurMessage}, DONâ€™T SLACK OFF! Give me a GitHub username, like .github xhclintohn! ğŸ˜¡\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      const username = arg.join(' ').trim();
      await repondre(`ï¿½	Tğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ Yo ${nomAuteurMessage}, stalking "${username}" on GitHub like a pro! ğŸ”\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);

      const apiUrl = `https://api.giftedtech.web.id/api/stalk/gitstalk?apikey=gifted&username=${encodeURIComponent(username)}`;
      const response = await axios.get(apiUrl);
      const data = response.data;

      if (!data.success || !data.result) {
        return repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ OOF, ${nomAuteurMessage}! Somethingâ€™s busted with the API! Try again later! ğŸ˜£\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      if (data.result.message === 'Not Found') {
        return repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ NOPE, ${nomAuteurMessage}! "${username}" doesnâ€™t exist on GitHub! What a loser! ğŸ˜¤\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
      }

      // Assuming valid user data includes fields like login, bio, public_repos, etc.
      const user = data.result;
      const bio = user.bio || 'No bio';
      const repos = user.public_repos || 0;
      const followers = user.followers || 0;
      const following = user.following || 0;

      await zk.sendMessage(
        dest,
        {
          text: `ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ BOOM, ${nomAuteurMessage}! Got the dirt on "${username}"! ğŸ”¥\nâ”‚â’ Username: ${user.login}\nâ”‚â’ Bio: ${bio}\nâ”‚â’ Repos: ${repos}\nâ”‚â’ Followers: ${followers}\nâ”‚â’ Following: ${following}\nâ”‚â’ Powered by xh_clinton\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`,
          footer: `Hey ${nomAuteurMessage}! I'm Toxic-MD, created by ğ±ğ¡_ğœğ¥ğ¢ğ§ğ­ğ¨ğ§ ğŸ˜`,
        },
        { quoted: ms }
      );

    } catch (e) {
      console.error('GitHub stalk error:', e);
      await repondre(`ğ“ğğ—ğˆğ‚-ğŒğƒ\n\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ\nâ”‚â’ CRASHED HARD, ${nomAuteurMessage}! Something broke: ${e.message} ğŸ˜¡ Fix it or get lost!\nâ—ˆâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â—ˆ`);
    }
  }
);